---
title: "問い合わせ設計 — 営業スパム対策の多層防御システム"
date: 2025-08-15
draft: true
categories: ["Web管理"]
tags: ["スパム対策", "フォーム実装", "セキュリティ", "実装戦略", "多層防御"]
description: "製造業Webサイトの問い合わせフォームにおける営業スパム対策。Recaptchaから自社開発のキーワードフィルタへの移行、honeypot、送信間隔制限など、4層防御システムの実装判断と試行錯誤を記録。"
---

## はじめに：営業スパムの増加と対応の必要性

製造業のウェブサイトは、営業スパムの格好の標的になる。問い合わせフォームを公開すれば、融資、ファクタリング、投資、採用代行――さまざまな営業メールが毎日のように届くようになる。

当社のウェブサイトも例外ではなかった。HPリニューアル後、問い合わせフォームを設置したが、営業メール対策はほぼゼロの状態。HAIK（Quick Homepage Maker）の基本的なフォーム機能だけで、スパムメールが日々増えていった。

最初は「Recaptcha を入れれば解決するだろう」と考えていた。ところが、開発サイドに依頼できないという現実に直面する。ここで方針を転換することになった。「完全な防御」ではなく「自分たちで実装できる多層防御」を目指す――この判断が、スパム対策の実装戦略の出発点になった。

一見、小粒に見える対策の積み重ねだが、実は戦略的な判断がいくつも含まれている。この記事では、その試行錯誤の過程を記録したい。

---

## 第1章：対策がなかった状態から始まる

### 1-1. 最初の状況

HPリニューアル直後、問い合わせフォームには営業メール対策がほとんど入っていなかった。HAIK のフォーム機能（qform）をそのまま使っていて、ユーザーが入力した内容をそのままメール送信する仕組みだ。

営業スパムは日々増えていった。融資、ファクタリング、投資案内、採用代行、SEO 対策――業種はさまざまだが、共通点がある。どれも「自動送信ツール」か「テンプレート的な文章」で送られてくるのだ。

毎朝メールを開くたびに、本当の問い合わせとスパムを見分ける作業が必要になっていた。

### 1-2. 開発サイドに依頼できない現実

最初に考えたのは Recaptcha の導入だった。Google が提供するスパム対策機能で、ユーザー体験も普及している。「これを入れれば解決するだろう」と思っていた。

ところが、ここで大きな壁にぶつかった。**開発サイドが機能していない**という現実だ。外注先のベンダーは既に契約が終了していて、新しい機能を追加する体制がない。Recaptcha を入れるには qform の大改修が必要だったが、それを頼める先がなかった。

それに、Recaptcha 自体にも少し不安があった。普及しているとはいえ、bot が突破する可能性もある。完全な防御にはならないかもしれない。

この時点で、方針を変えることにした。**「完全な防御」ではなく「自分たちで実装できる多層防御」を目指す**――これが Issue #13 の実装戦略の出発点になった。

---

## 第2章：4層防御システムの実装

### 2-1. 実装した対策

Recaptcha が使えないなら、自分たちで作るしかない。そう決めて、まず考えたのが「複数の軽い対策を組み合わせる」という方針だった。単一の防御では不十分だが、複数の層を重ねれば効果が上がるはずだ。

最終的に実装したのは、以下の **4層防御システム** だった。

**第1層：キーワード自動判定フィルタ**

まず、営業メールによく出てくる言葉をリストアップした。実際に届いたスパムメールを分析して、30個のキーワードを抽出する。

例えば：営業、売込、投資、FX、融資、ファクタリング、急募、経験不問、給与交渉、無料診断、緊急対応……など。

これらのキーワードが問い合わせ本文に含まれていたら、自動で拒否する仕組みだ。シンプルだが、効果は大きかった。

**第2層：件名フィルタ**

件名にも注目した。営業メールの多くは、件名に「営業」という言葉をそのまま入れてくることが多い。

「営業提案」「営業代行」「営業支援」「営業電話」「営業メール」――こうしたキーワードが件名に含まれていたら、これも自動拒否する。

**第3層：honeypot 対策（隠しフィールド）**

これは少しトリッキーな方法だ。フォームに「website」という隠しフィールドを用意する。このフィールドは CSS で非表示にしてあるので、人間には見えない。

ところが、自動送信ツール（bot）は、フォームのすべてのフィールドを埋めようとする。隠しフィールドに何か入力されていたら「これは bot だ」と判断して、自動拒否する仕組みだ。

**第4層：送信間隔制限**

最後の層は、送信間隔の監視だ。同一 IP アドレスから 5 秒以内に連続して送信されたら、自動拒否する。

人間が手動で送信する場合、5秒以内に連続送信することはまずない。これも自動送信ツール対策として有効だった。

### 2-2. 実装判断の根拠

この4層防御を設計するとき、いくつかの判断があった。

**Recaptcha を諦めた理由**

開発サイドに依頼できないという物理的な制約が第一だった。ただ、仮に導入できたとしても、bot が突破する可能性はゼロではない。完全な防御にはならないだろうと考えていた。

**自社開発フィルタを選んだ理由**

初期コストが低く、拡張性がある。キーワードリストは後から追加できるし、新しい層を追加することもできる。自分たちで管理できるというのが大きかった。

**多層防御にした理由**

単一の防御では不十分だと感じていた。キーワードフィルタだけでは、すり抜けるスパムもある。honeypot だけでは、手動で送信する営業メールには効かない。

複数の層を組み合わせることで、それぞれの弱点を補い合う。この設計思想が、4層防御の基盤になった。

---

## 第3章：営業メール分析から得たキーワード抽出と進化

### 3-1. スパムメールの特徴分析

キーワードフィルタを作るには、まず敵を知る必要がある。実際に届いた営業メールを片っ端から分析してみた。

ここで Claude に協力してもらった。営業メールのサンプルをいくつか渡して、「業種ごとのパターンとキーワードを抽出してほしい」と依頼したのだ。すると、業種ごとにはっきりとしたパターンが見えてきた。

**融資・ファクタリング系**

「融資」「急ぎ」「最短入金」「資金繰り」「審査なし」といったキーワードが頻出する。特に「最短」「即日」など、スピード感を強調する言葉が多い。

**投資・FX 系**

「投資」「配当」「自動売買」「リスクゼロ」「高利回り」など。こちらは利益を前面に出してくる。

**採用・派遣系**

「急募」「経験不問」「給与交渉」「即日勤務」「高時給」といった言葉が並ぶ。人材不足を前提にした営業が多かった。

**その他提案系**

「無料診断」「緊急対応」「今だけ」「限定」など。urgency（緊急性）を煽る言葉が目立つ。

こうして抽出したキーワードを整理して、最初は **30語のリスト** を作った。

### 3-2. キーワード化の工夫と現状

初期の 30 語は管理しやすかった。数が少ないので、メンテナンスも簡単だ。

ところが、実運用を始めると「すり抜けた問い合わせ」が何件か届いた。最初は「フィルタが甘いのか？」と思ったが、内容を見て驚いた。

**すり抜けたのは、すべて正当な問い合わせだった。**

それらは、丁寧な文章で書かれていて、「書いた人の熱意」が伝わってくるものばかりだった。キーワードに引っかからなかったのは、テンプレート的な文章ではなく、自分の言葉で書かれていたからだ。

これは想定外の、しかし嬉しい発見だった。フィルタは「bot や機械的なスパム」を排除しつつ、「人間らしい問い合わせ」はちゃんと通していたのだ。

その後、キーワードリストは拡張を続けた。新しいパターンのスパムが出てくるたびに、キーワードを追加していく。30 語から始まったリストは、今ではもっと多くのキーワードを含んでいる。

**結果として、bot 処理的な「機械的・テンプレート的」な文章は、ほとんど見かけなくなった。**

### 3-3. 「完全な自動化」の限界と現実

キーワードフィルタは成功した。自動送信ツール（bot）はほぼ排除できている。

ただし、限界もある。**正当な問い合わせまで排除することはできない。** むしろ、それをすべきではない。フィルタの目的は「ノイズを減らすこと」であって、「すべてを遮断すること」ではないからだ。

今も残っている課題がある。それは **人間が手動で、フィルタを意識して送ってくる営業メール** だ。

bot ではなく、営業担当者が自分でフォームを開いて、キーワードを避けながら、丁寧な文章を書いて送ってくる。その場でフィルタのトラップを考えながら入力しているので、機械的に排除することは難しい。

ただし、こうしたメールは少数だ。全体のノイズは大幅に減っているので、この程度なら許容範囲だと判断している。手動で内容を見て判断すればいい。

完全な自動化ではなく、「十分に効果のある自動化」――これが、現実的な落としどころだった。

---

## 第4章：Gmailテンプレートの日本語置き換え問題

### 4-1. Issue #12 との関連

スパム対策を実装している最中に、別の問題が浮上した。Gmail の管理者メールテンプレートで、日本語の置き換えがうまくいかないのだ。

実はこれ、Issue #12「日本語処理の落とし穴」で扱ったエンコーディング問題と同じ根っこを持っていた。フォーム側で「\*」（必須マーク）が文字化けしたのと同様に、Gmail 側でも文字エンコーディングの不整合が起きていたのだ。

最初は気づかなかった。スパム対策のキーワードフィルタやhoneypot の実装に夢中で、メールテンプレートまで気が回らなかったからだ。ところが、実際にテストメールを送ってみると、日本語が「□」に化けている。

「あれ、これどこかで見たな」と思った。Issue #12 で経験した、まさにあの問題だった。

### 4-2. 具体的なトラブルケース

問題は2つあった。

**1つ目：フォーム確認メール送信時の文字化け**

問い合わせフォームから送信した確認メールで、日本語が「□」に変換されてしまう。原因を調べると、フォーム側（PHP UTF-8）とメールサーバー側（ISO-2022-JP）のエンコード不整合だった。

フォーム側では UTF-8 で処理しているのに、メール送信時に ISO-2022-JP に変換されていない。そのまま送信されるから、受信側で文字化けが起きる。

**2つ目：テンプレート置き換えが機能しない**

もっと厄介だったのが、テンプレートの日本語置き換えが動かないことだった。

最初は「件名：{{件名}}」「お名前：{{お名前}}」といったプレースホルダーを用意して、実際の値に置き換える仕組みを作っていた。ところが、テストしてみると、プレースホルダーがそのまま送信される。置き換えが機能していない。

原因を探ると、Heredoc 構文内で `mb_*` 関数を使っていなかったことが判明した。PHP の文字列処理では、マルチバイト文字（日本語）を扱うときは `mb_internal_encoding()` を明示的に設定する必要がある。これを Heredoc 内でもやらないと、日本語の置き換えが正しく動作しないのだ。

### 4-3. ローカル環境とサーバー環境の違いという落とし穴

ここで、さらに厄介な問題が発覚した。**ローカル環境では正常に動いていたのに、サーバーにアップロードしたら動かなくなった**のだ。

ローカル（Mac）で開発しているときは、テンプレート置き換えも文字化けも起きていなかった。「よし、完成だ」と思ってサーバーにアップロードしたら、いきなり文字化けが発生する。

原因は、**ローカルとサーバーで PHP の初期設定値が異なっていた**ことだった。

- **ローカル環境**：PHP の初期設定で `mbstring.internal_encoding` が UTF-8 に設定されていた
- **サーバー環境**：初期設定が明示されておらず、デフォルト値（おそらく ISO-8859-1）が使われていた

つまり、ローカルでは「たまたま」正しい設定になっていたから動いていただけで、サーバーでは明示的に設定しないと動かなかったのだ。

この経験から学んだのは、**「明示的に設定する」ことの重要性**だった。環境に依存せず、どこでも同じ動作をさせるには、初期設定値に頼らず、コード内で明示的にエンコーディングを指定する必要がある。

（この「初期設定値の罠」については、Issue #12 で詳しく扱っている）

### 4-4. 解決策

解決策は2つ。

**メール送信時に明示的にエンコード指定**

メール送信時に、文字エンコーディングを明示的に ISO-2022-JP に変換する処理を追加した。これでフォーム側（UTF-8）とメールサーバー側（ISO-2022-JP）の不整合が解消された。

**Heredoc 内でも mb_internal_encoding() 設定**

テンプレート置き換えの処理では、Heredoc 構文の前に `mb_internal_encoding('UTF-8')` を明示的に設定した。環境に依存せず、必ず UTF-8 で処理されるようにした。

地味だが、こうした小さな設定の積み重ねが、実装の安定性を支えている。Issue #12 で学んだエンコーディングの知識が、ここで活きた形になった。

---

## 第5章：フォーム側とメール送信処理の分離

### 5-1. 実装の方針

4層防御システムを設計するとき、もう一つ重要な判断があった。それは「どこで何を処理するか」という役割分担だ。

最初は深く考えていなかった。「フォームでチェックして、NGワードに引っかかったら拒否すればいい」と単純に考えていた。ところが、実装を進めるうちに、もっと複雑な構造が必要だと気づいた。

最終的に決めた方針は、以下の3層での処理分離だった：

- **フォーム処理**：キーワード、件名、honeypot、送信間隔でチェック → リアルタイム拒否
- **メール送信処理**：フォームをバイパスした直接送信への対策（同じNGワードチェック）
- **Gmail 側**：スパムフォルダ自動分類

この3層がそれぞれ異なる役割を持っている。なぜこうなったのか、試行錯誤の過程を振り返ってみる。

### 5-2. 試行錯誤のポイント

**最初の実装：フォーム側だけで処理**

最初は、フォーム処理ですべてチェックして、NGワードに引っかかったら「送信できません」とエラーメッセージを返す仕組みを作った。

シンプルでわかりやすい。問題ないように見えた。

ところが、ある日気づいた。**フォームのHTMLを見れば、送信先のプログラムURLがわかる。** 攻撃者がそこに気づけば、フォームをスキップして、直接メール送信プログラムにPOSTリクエストを送ることができる。

つまり、フォーム処理でどんなに厳格にチェックしても、そこを通らずに直接送信されたら意味がない。

**改善案：メール送信処理でも同じチェックを入れる**

そこで、メール送信処理の中にも、同じNGワードチェックを追加した。

最初は「フォーム処理にだけNGワードを追加すればいい」と思っていたが、それでは不十分だった。NGワードを追加するときは、**フォーム処理とメール送信処理の両方に追加する**必要がある。

これで、2つのルートが守られた：
- 通常ルート：フォームから送信 → フォーム処理でチェック
- 攻撃ルート：フォームをバイパス → メール送信処理でチェック

**最後の防衛ライン：Gmail 側のフィルタ**

それでもすり抜けるスパムがあった。新しいパターンのスパムや、NGワードリストに載っていない言葉を使ったものだ。

そこで、Gmail 側でも追加のフィルタリングを設定した。これをすり抜けたメールでも、Gmail が自動でスパムフォルダに振り分けてくれる。

この3層構造で、スパムメール受信が格段に減った。

### 5-3. 「到達しないメール」が見えない問題

ただし、この構造には一つ問題がある。**フォーム処理やメール送信処理で弾いたメール（到達しないメール）の正確な数は、後から把握しにくい**ということだ。

拒否した瞬間はログに残るが、それを集計して「今月は何件のスパムを止めたか」を正確に把握するのは手間がかかる。実装当初は、そこまで細かい統計を取る仕組みを作っていなかった。

Gmail に届いたメール（スパムフォルダに入ったものも含む）は数えられる。でも、Gmail に届く前にフォーム処理・メール送信処理で止めたメールは、意識的に記録しないと見えなくなる。

でも、これは仕方がないと判断した。完璧な統計を取るより、実際にスパムメールが減ることの方が重要だからだ。

実感としては、Gmail の受信トレイに届く営業メールが格段に減った。日々のメールチェックで、営業メールを手作業で削除する作業がほぼなくなった。それで十分だった。

---

## 第6章：実装判断 - 完全性より実用性

### 6-1. 妥協した部分と現実

ここまで4層防御システムの実装を振り返ってきたが、正直に言えば「完璧なシステム」ではない。妥協した部分がいくつもある。

**完全な営業メール排除は不可能だ。**

どんなにキーワードを増やしても、新しいパターンのスパムは出てくる。攻撃者（営業側）も学習するからだ。今日有効だったキーワードが、明日には回避される。

キーワード辞書は継続的に拡張が必要だし、新しいスパムパターンは常に出現する。イタチごっこだ。

でも、それでいいと判断した。**「運用可能な範囲」で十分な効果を実現できればいい**からだ。100%の防御を目指して複雑なシステムを作るより、80%の防御を簡単に運用できる方が、零細企業には合っている。

### 6-2. 自動化と人的判断の組み合わせ

もう一つの妥協点は、「完全な自動化」を諦めたことだ。

bot が処理した機械的スパムは、フィルタでほぼ排除できた。これは成功だった。

でも、**人間が手動で書いた営業メール（熱意のある文章）は、今も到達する。** フィルタを意識してキーワードを避け、丁寧な文章で送ってくるからだ。

最初は「これも自動で弾けないか」と考えたが、やめた。なぜなら、こうした丁寧な文章は、**正当な問い合わせとの区別が難しい**からだ。無理に弾こうとすると、大事な問い合わせまで拒否してしまう。

結局、こうした「人間らしい営業メール」は、受信してから内容を見て判断することにした。完全な自動化ではなく、**「ノイズ削減」としての位置付け**だ。

bot による大量スパムを止めることで、手作業で判断する数を減らす。それで十分だった。

### 6-3. 運用効率の改善

実装後、明らかに変わったことがある。

**日々の手作業でのスパムメール削除が激減した。**

以前は毎朝、受信トレイに10〜20件の営業メールが溜まっていた。それを一つ一つ開いて、内容を確認して、削除する作業が必要だった。

今は、その作業がほぼない。たまに到達する「人間らしい営業メール」を見るだけだ。

新しいスパムパターンが出てきても、対応は簡単だ。**キーワード辞書を更新するだけで、新パターンに対応できる。** フォーム処理とメール送信処理の両方に追加すればいい。数分の作業だ。

ユーザー体験も維持できている。フォームから送信すれば、正常に見える。スパムは背後で排除されているが、正当な問い合わせはちゃんと届く。

完璧ではないが、**実用的なシステム**になった。それが、この実装判断の結論だった。

---

## おわりに：スパム対策は実装戦略である

営業スパム対策は、単なる「セキュリティ機能」ではない。**ビジネス判断であり、実装戦略だ。**

Recaptcha という「完璧な解決策」を諦め、自社開発のキーワードフィルタという「実用的な解決策」を選んだ。完全な防御を目指さず、「十分」な状態を維持することを優先した。

複数の軽い対策（多層防御）を組み合わせることで、堅牢性を高めた。自動化と人的判断のバランスを取ることで、実装の現実性を確保した。

小粒に見える対策だが、実装の意思決定がいくつも詰まっている。フォーム処理とメール送信処理の役割分担、NGワードの継続的な更新、環境差異への対応――これらすべてが、試行錯誤の中で生まれた判断だった。

この記録が、同じような課題に直面している人の参考になれば幸いだ。
